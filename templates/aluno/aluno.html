{% extends "base.html" %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/aluno.css' %}">
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Alpine.js CDN -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock style %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold mb-6">Alunos Cadastrados</h2>
  {% if user.is_authenticated %}
  Olá, {{ user.username }}!
  {% else %}
  Olá, visitante!
  {% endif %}
  <div class="flex justify-end p-4">
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Logout
      </button>
    </form>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    {% for aluno in alunos %}
    <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">{{ aluno.nome }}</h3>
      <p class="text-sm text-gray-600"><strong>CPF:</strong> {{ aluno.cpf }}</p>
      <p class="text-sm text-gray-600"><strong>Email:</strong> {{ aluno.email }}</p>
      <p class="text-sm text-gray-600"><strong>Telefone:</strong> {{ aluno.telefone }}</p>
      <p class="text-sm text-gray-600"><strong>Status:</strong> {{ aluno.status|yesno:"Ativo,Inativo" }}</p>
      <p class="text-sm text-gray-600"><strong>Instrutor:</strong> {{ aluno.nome_instrutor }}</p>
      <button type="button"
        class="mt-4 inline-block px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700"
        data-bs-toggle="modal" data-bs-target="#editModal" data-id="{{ aluno.cod_aluno }}" data-nome="{{ aluno.nome }}"
        data-cpf="{{ aluno.cpf }}" data-email="{{ aluno.email }}" data-telefone="{{ aluno.telefone }}"
        data-status="{{ aluno.status }}" data-cod_instrutor="{{ aluno.cod_instrutor }}">
        Editar
      </button>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" id="editForm" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Editar Aluno</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
              <!-- Campo oculto com cod_aluno -->
              <input type="hidden" name="cod_aluno" id="edit-cod_aluno">

              <div class="bg-white p-4 rounded-lg">
                <div class="relative bg-inherit">
                  <input type="text" id="edit-nome" name="nome"
                    class="peer bg-transparent h-10 w-full rounded-lg text-gray-800 placeholder-transparent ring-2 px-2 ring-gray-500 focus:ring-sky-600 focus:outline-none"
                    placeholder="Nome" required />
                  <label for="edit-nome"
                    class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Nome</label>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg mt-3">
                <div class="relative bg-inherit">
                  <input type="text" id="edit-cpf" name="cpf"
                    class="peer bg-transparent h-10 w-full rounded-lg text-gray-800 placeholder-transparent ring-2 px-2 ring-gray-500 focus:ring-sky-600 focus:outline-none"
                    placeholder="CPF" />
                  <label for="edit-cpf"
                    class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">CPF</label>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg mt-3">
                <div class="relative bg-inherit">
                  <input type="email" id="edit-email" name="email"
                    class="peer bg-transparent h-10 w-full rounded-lg text-gray-800 placeholder-transparent ring-2 px-2 ring-gray-500 focus:ring-sky-600 focus:outline-none"
                    placeholder="Email" required />
                  <label for="edit-email"
                    class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Email</label>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg mt-3">
                <div class="relative bg-inherit">
                  <input type="text" id="edit-telefone" name="telefone"
                    class="peer bg-transparent h-10 w-full rounded-lg text-gray-800 placeholder-transparent ring-2 px-2 ring-gray-500 focus:ring-sky-600 focus:outline-none"
                    placeholder="Telefone" required />
                  <label for="edit-telefone"
                    class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Telefone</label>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg mt-3">
                <div class="flex items-center space-x-3">
                  <input type="checkbox" id="edit-status" name="status"
                    class="h-5 w-5 text-sky-600 focus:ring-sky-500 border-gray-300 rounded" />
                  <label for="edit-status" class="text-gray-700 text-sm">Status Ativo</label>
                </div>
              </div>

              <div class="bg-white p-4 rounded-lg mt-3">
                <div class="relative bg-inherit">
                  <input type="text" id="edit-cod_instrutor" name="cod_instrutor"
                    class="peer bg-transparent h-10 w-full rounded-lg text-gray-800 placeholder-transparent ring-2 px-2 ring-gray-500 focus:ring-sky-600 focus:outline-none"
                    placeholder="Código do Instrutor" required />
                  <label for="edit-cod_instrutor"
                    class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Código
                    do Instrutor</label>
                </div>
              </div>

            </div>

            <div class="modal-footer">
              <button type="submit"
                class="inline-block px-6 py-3 mr-3 font-bold text-center text-white uppercase align-middle transition-all rounded-lg cursor-pointer bg-lime-500 leading-pro text-xs ease-soft-in tracking-tight-soft shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85 hover:shadow-soft-xs">Salvar</button>
              <button type="button"
                class="inline-block px-6 py-3 mr-3 font-bold text-center text-white uppercase align-middle transition-all bg-red-500 rounded-lg cursor-pointer leading-pro text-xs ease-soft-in tracking-tight-soft shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85 hover:shadow-soft-xs"
                data-bs-dismiss="modal">Cancelar</button>
            </div>

          </form>
        </div>
      </div>
    </div>


    <!-- Script para preencher o modal -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var editModal = document.getElementById('editModal');

        // Adiciona evento de abertura do modal
        editModal.addEventListener('show.bs.modal', function (event) {
          var button = event.relatedTarget;

          // Verifica se estamos editando um aluno ou criando um novo
          var isNew = button.getAttribute('data-action') === 'new';

          // Se for um novo aluno, limpa os campos
          if (isNew) {
            // Define o título do modal
            document.getElementById('editModalLabel').textContent = 'Adicionar Novo Aluno';

            // Limpa os campos do formulário
            document.getElementById('edit-cod_aluno').value = '';
            document.getElementById('edit-nome').value = '';
            document.getElementById('edit-cpf').value = '';
            document.getElementById('edit-email').value = '';
            document.getElementById('edit-telefone').value = '';
            document.getElementById('edit-status').checked = false;
            document.getElementById('edit-cod_instrutor').value = '';

            // Ajusta a ação para a URL de inserção
            document.getElementById('editForm').action = '/inserir_aluno/';
          } else {
            // Caso contrário, é para editar
            var cod_aluno = button.getAttribute('data-id');
            var nome = button.getAttribute('data-nome');
            var cpf = button.getAttribute('data-cpf');
            var email = button.getAttribute('data-email');
            var telefone = button.getAttribute('data-telefone');
            var codInstrutor = button.getAttribute('data-cod_instrutor');
            var status = button.getAttribute('data-status') === 'true';

            document.getElementById('edit-cod_aluno').value = cod_aluno;
            document.getElementById('edit-nome').value = nome;
            document.getElementById('edit-cpf').value = cpf;
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-telefone').value = telefone;
            document.getElementById('edit-cod_instrutor').value = codInstrutor;
            document.getElementById('edit-status').checked = status;

            // Ajusta a ação para a URL de edição
            document.getElementById('editForm').action = `/Aluno/editar/${cod_aluno}/`;

            // Define o título do modal
            document.getElementById('editModalLabel').textContent = 'Editar Aluno';
          }
        });
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        if (params.get('editado') === 'true') {
          const alertContainer = document.getElementById('alert-container');
          const alert = document.createElement('div');
          alert.className = 'relative w-full p-4 text-white rounded-lg bg-lime-500 text-center';
          alert.textContent = 'Alterações salvas com sucesso!';
          alertContainer.appendChild(alert);
          setTimeout(() => alert.remove(), 3000);
        }
      });
    </script>
    {% empty %}
    <p class="col-span-4 text-center text-gray-500">Nenhum aluno cadastrado.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}